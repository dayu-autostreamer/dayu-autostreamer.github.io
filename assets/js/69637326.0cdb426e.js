"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1123],{4437:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"developer-guide/how-to-build/docker-registry","title":"Docker Registry Configuration","description":"To solve connection issues with the Docker image repository, two ways can be chosen: using a registry mirror and setting up an internal private repository.","source":"@site/docs/04-developer-guide/02-how-to-build/03-docker-registry.md","sourceDirName":"04-developer-guide/02-how-to-build","slug":"/developer-guide/how-to-build/docker-registry","permalink":"/docs/developer-guide/how-to-build/docker-registry","draft":false,"unlisted":true,"editUrl":null,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_label":"Docker Registry Configuration","slug":"/developer-guide/how-to-build/docker-registry","custom_edit_url":null,"unlisted":true,"displayed_sidebar":null}}');var n=t(4848),s=t(8453);const o={sidebar_label:"Docker Registry Configuration",slug:"/developer-guide/how-to-build/docker-registry",custom_edit_url:null,unlisted:!0,displayed_sidebar:null},a="Docker Registry Configuration",d={},c=[{value:"Use registry mirror",id:"use-registry-mirror",level:2},{value:"Configure internal private repository",id:"configure-internal-private-repository",level:2},{value:"Set up a private repository (skip if a private repository already exists)",id:"set-up-a-private-repository-skip-if-a-private-repository-already-exists",level:3},{value:"Client settings to use private repositories",id:"client-settings-to-use-private-repositories",level:3}];function l(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"docker-registry-configuration",children:"Docker Registry Configuration"})}),"\n",(0,n.jsxs)(r.p,{children:["To solve connection issues with the ",(0,n.jsx)(r.a,{href:"https://hub.docker.com/repositories/",children:"Docker image repository"}),", two ways can be chosen: using a registry mirror and setting up an internal private repository."]}),"\n",(0,n.jsx)(r.h2,{id:"use-registry-mirror",children:"Use registry mirror"}),"\n",(0,n.jsxs)(r.p,{children:["Use a third-party registry mirror, add the domain to ",(0,n.jsx)(r.code,{children:"/etc/docker/daemon.json"})," (",(0,n.jsx)(r.a,{href:"https://www.wangdu.site/course/2109.html",children:"partial available registry mirror"}),")."]}),"\n",(0,n.jsx)(r.p,{children:"(Disadvantages: slower speed; Applicable scenarios: pulling external images)"}),"\n",(0,n.jsx)(r.p,{children:"modify daemon.json"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'sudo tee /etc/docker/daemon.json <<EOF\n{\n    "registry-mirrors": ["https://xxx","https://xxx"]\n}\nEOF\n'})}),"\n",(0,n.jsx)(r.p,{children:"restart docker"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"sudo systemctl daemon-reload\nsudo systemctl restart docker\n"})}),"\n",(0,n.jsx)(r.h2,{id:"configure-internal-private-repository",children:"Configure internal private repository"}),"\n",(0,n.jsx)(r.p,{children:"Deploy a private image repository of your own configuration within the internal network."}),"\n",(0,n.jsx)(r.p,{children:"(Disadvantages: Lack of external mirrors; Applicable scenarios: Mirrors required by the storage system itself, or for storing external mirrors)"}),"\n",(0,n.jsx)(r.h3,{id:"set-up-a-private-repository-skip-if-a-private-repository-already-exists",children:"Set up a private repository (skip if a private repository already exists)"}),"\n",(0,n.jsx)(r.p,{children:"Select a Linux host that can be connected to within the intranet (here take 114.212.87.136 as an example)."}),"\n",(0,n.jsxs)(r.p,{children:["Run ",(0,n.jsx)(r.code,{children:"registry"})," to build the Docker repository"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# Create image storage directory\nmkdir -p /data/registry\n# Pull image\ndocker pull registry\n# Run registry\ndocker run -d --name registry -v /data/registry:/var/lib/registry -p 5000:5000 --restart=always -e REGISTRY_STORAGE_DELETE_ENABLED=true registry \n"})}),"\n",(0,n.jsx)(r.p,{children:"Check the running status"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'~$ sudo docker ps\nCONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                       NAMES\n050306825f5f   6a3edb1d5eb6   "/entrypoint.sh /etc\u2026"   37 minutes ago   Up 32 minutes   0.0.0.0:5000->5000/tcp, :::5000->5000/tcp   frosty_raman\n'})}),"\n",(0,n.jsx)(r.p,{children:"Modify the configuration file"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# Remove the configuration file from the container\ndocker cp registry:/etc/docker/registry/config.yml ./config.yml\n# Load the modified configuration file into the container\ndocker cp ./config.yml registry:/etc/docker/registry/config.yml \n# Restart container\ndocker restart registry\n"})}),"\n",(0,n.jsx)(r.p,{children:"Create UI for private repository"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'docker run -d \\\n  --name registry-ui \\\n  -p 8080:80 \\\n  -e REGISTRY_TITLE="xxx" \\  # Enter the name you want to display on the front end.\n  -e REGISTRY_URL="http://114.212.87.136:5000" \\  # Enter IP\n  -e SINGLE_REGISTRY=true \\\n  -e DELETE_IMAGES=true \\\n  -e SHOW_CATALOG_NB_TAGS=true \\\n  --link registry \\\n  --restart=always \\\n  joxit/docker-registry-ui:latest\n \n# Visit http://114.212.87.136:8080 to view the page\n'})}),"\n",(0,n.jsx)(r.p,{children:"Regularly recycle garbage (files still exist after deleting the mirror index)"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'docker exec -it registry registry garbage-collect  /etc/docker/registry/config.yml | grep "blob eligible for deletion:"\n'})}),"\n",(0,n.jsx)(r.h3,{id:"client-settings-to-use-private-repositories",children:"Client settings to use private repositories"}),"\n",(0,n.jsx)(r.p,{children:"Set up on devices that need to use the private repository"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'# set hostname\nsudo vim /etc/hosts\n# add\n114.212.87.136 repo\n\n# configure docker daemon\nsudo vim /etc/docker/daemon.json\n# add\n{\n    "insecure-registries": ["repo:5000", "114.212.87.136:5000"]\n}\n\n# restart docker\nsudo systemctl daemon-reload\nsudo systemctl restart docker\n'})}),"\n",(0,n.jsx)(r.p,{children:"Use private repository"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"# tag image\ndocker tag dayuhub/backend:v1.0 repo:5000/dayuhub/backend:v1.0\n# or: docker tag dayuhub/backend:v1.0 114.212.87.136:5000/dayuhub/backend:v1.0\n\n# push image\ndocker push repo:5000/dayuhub/backend:v1.0\n# or: docker push 114.212.87.136:5000/dayuhub/backend:v1.0\n\n# pull image\ndocker pull repo:5000/dayuhub/backend:v1.0\n# or: docker pull 114.212.87.136:5000/dayuhub/backend:v1.0\n"})}),"\n",(0,n.jsxs)(r.p,{children:["When compiling and building images in the dayu system, please configure env parameter ",(0,n.jsx)(r.code,{children:"REG"})," and ",(0,n.jsx)(r.code,{children:"buildkitd.toml"})," to use the private repository. For details, please refer to ",(0,n.jsx)(r.a,{href:"/docs/developer-guide/how-to-build/build-components#quick-building",children:"Build Components"}),"."]})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,r,t)=>{t.d(r,{R:()=>o,x:()=>a});var i=t(6540);const n={},s=i.createContext(n);function o(e){const r=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),i.createElement(s.Provider,{value:r},e.children)}}}]);